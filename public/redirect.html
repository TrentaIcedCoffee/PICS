<!-- TODO welcome -> 404 -->
<!-- TODO inner -> package -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- jQuery 2.0.0 CDN -->
    <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
    <!-- Angular CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <!-- bootstrap 3 CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <!-- customized packages -->
    <script src="js/exceptions.js"></script>
    <script src="js/date.js"></script>
    <script src="js/util.js"></script>
    <script src="js/crypto/core.js"></script>
    <script src="js/crypto/enc-base64.js"></script>
    <script src="js/crypto/hmac.js"></script>
    <script src="js/crypto/sha256.js"></script>
    <script src="js/crypto/util.js"></script>
    <title>Redirect - Debug</title>
    <style>
        html, body {
            width: 100%;
            font-family: 'Roboto', sans-serif;
        }
        #header {
            height: 50px;
        }
        #header div a {
            margin: 0px;
            float: none;
            display: block;
            text-align: center;
        }
        #header div form {
            margin: 0px;
            padding-top: 8px;
        }
        #private-info {
            position: absolute;
            top: 50px;
            display: none;
        }
        .input-private {
            width: 100%;
            background: black;
            border-radius: 15px;
            padding-top: 5px;
            padding-bottom: 10px;
        }
        .input-private label {
            display: block;
            text-align: center;
            color: white;
        }
        .input-private .input-group {
            margin-left: 10px;
            margin-right: 10px;
        }
        .input-private .input-group input {
            font-size: 16px;
        }
        .dropdown-private {
            background: black;
            border-radius: 15px;
            padding-top: 15px;
            padding-bottom: 15px;
        }
        .dropdown-private > div.input-group {
            margin-left: 10px;
            margin-right: 10px;
        }
        .dropdown-private > div.input-group > button {
            width: 100%;
            font-size: 16px;
        }
        .dropdown-menu li {
            padding-left: 10%;
            font-size: 16px;
        }
        #body {
            margin-top: 50px;
        }
        #body table th {
            text-align: center;
        }
        #body table td {
            text-align: center;
        }
        #body table td.note-public {
            text-align: left;
        }
    </style>
</head>
<body>
    <script>
        // usr validation
        var cookie = document.cookie;
        if (cookie == undefined || cookie == "") {
            window.location.replace('welcome.html');
        }
        var jwt = getJwtInCookie(cookie);
        var email = getEmailInJwt(jwt);
        var _id = getIdOfEmail(email);
        if (!isValidJwt(jwt, _id)) {
            window.location.replace('welcome.html'); // TODO welcome -> 404
        }
    </script>
    <script>
        // $.ajax({url: `users/${_id}`, async: true, dataType: 'json'}).done(function(res) {
        //     var user = res;
        //     console.log(user);
        // });
        var user = JSON.parse($.ajax({url: `users/${_id}`, async: false, dataType: 'json'}).responseText);
        var users = JSON.parse($.ajax({url: 'users', async: false, dataType: 'json'}).responseText);

        var unlockInput = function(ele) {
            var input = ele.parentElement.previousSibling;
            input.readOnly = false;
        };

        var editInput = function(ele) {
            ele.readOnly = true;
        }

        var editDropdown = function(ele) {
            // TODO: impl POST
        }

        var privateInfoOf = function(user) {
            var result = '';
            result += '<ul class="nav nav-sidebar">';
            result += inputPrivateOf('Email', user.email);
            result += inputPrivateOf('Phone', user.phone);
            result += inputPrivateOf('End Date', user.stop_time);
            result += dropdownPrivateOf('Departments', user.dept_names);
            result += dropdownPrivateOf('Visas', user.visa_types);
            result += inputPrivateOf('Official University Email', `${user.working_email || ""}`);
            result += inputPrivateOf('Supervisor\'s Name', `${user.supervisor_name || ""}`);
            result += inputPrivateOf('Supervisor\'s Email', `${user.supervisor_email || ""}`);
            result += inputPrivateOf('Note', `${user.note || ""}`);
            result += '</ul>';
            return result;
        };

        var inputPrivateOf = function(name, value) {
            var result = '';
            result += '<div class="input-private">';
            result += `<label>${name}</label>`;
            result += '<div class="input-group">';
            result += `<input class="form-control" onchange="editInput(this)" readonly="readonly" value="${value}" />`
            result += '<span class="input-group-addon"><i class="glyphicon glyphicon-edit" onclick="unlockInput(this)"></i></span>';
            result += '</div>';
            result += '</div>';
            return result;
        };

        var dropdownPrivateOf = function(header, eles) {
            var result = '';
            result += '<div class="dropdown-private clearfix">';
            result += '<div class="input-group">';
            result += '<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">';
            result += `${header}`;
            result += '<span class="caret"></span>';
            result += '</button>';
            result += '<ul class="dropdown-menu">';
            result += `<li class="dropdown-header">${header}</li>`;
            for (var ele of eles) {
                result += `<li>${ele}</li>`;
            }
            result += '</ul>';
            result += '<span class="input-group-addon"><i class="glyphicon glyphicon-edit" onclick="editDropdown(this)"></i></span>';
            result += '</div>';
            result += '</div>';
            return result;
        };

        $(document).ready(function() {
            $('#private-info').html(privateInfoOf(user));
        });

        var togglePrivateInfo = function() {
            var caret = $('#private_info_toggle_caret');
            var privateInfo = $('#private-info');
            if (!caret.hasClass('caret-reversed')) {
                caret.addClass('caret-reversed');
                privateInfo.slideDown();
            } else {
                caret.removeClass('caret-reversed');
                privateInfo.slideUp();
            }
        };

        var tdPublicOf = function(val) {
            return `<td>${val}</td>`
        };

        var trNotePublic = function(val) {
            var result = '';
            result += '<tr>';
            result += `<td class="note-public" colspan="8">Note: ${val}</td>`;
            result += '</tr>';
            return result;
        };

        var tdMultiplePublicOf = function(array) {
            return '<td>' + array.join(',<br />') + '</td>';
        };

        var trPublicOf = function(user) {
            var result = '';
            result += '<tr>';
            result += tdPublicOf(user.name);
            result += tdPublicOf(user.phone);
            result += tdPublicOf(user.email);
            result += tdPublicOf(`${user.working_email || ""}`);
            result += tdMultiplePublicOf(user.dept_names);
            result += tdMultiplePublicOf(user.visa_types);
            result += tdPublicOf(`${user.supervisor_name || ""}`);
            result += tdPublicOf(`${user.supervisor_email || ""}`);
            result += '</tr>'
            if (user.note) {
                result += trNotePublic(user.note);
            }
            return result;
        };

        // txt is search text
        var publicInfoOf = function(users) {
            var result = '';
            for (var user of users) {
                result += trPublicOf(user);
            }
            return result;
        };

        $(document).ready(function() {
            $('#public-info').html(publicInfoOf(users));
        });
    </script>
    <nav id="header" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-3 navbar-header">
                  <a class="navbar-brand" onclick="togglePrivateInfo()">My Information <span class="caret" id="private_info_toggle_caret"></span></a>
                  <div id="private-info">

                  </div>
              </div>
              <div class="col-md-6 navbar-header">
                  <a class="navbar-brand" href="#">PICS - UC Davis Department Comtacts</a>
              </div>
              <form class="col-md-3 navbar-form navbar-right">
                  <input oninput="search(this)" type="text" class="form-control" placeholder="Search...">
              </form>
          </div>
      </div>
    </nav>
    <script>
        String.prototype.containsIgnoreCase = function(that) {
            var thisLowerCase = this.toLowerCase();
            var thatLowerCase = that.toLowerCase();
            return thisLowerCase.indexOf(thatLowerCase) != -1;
        };

        Array.prototype.containsStrIgnoreCase = function(that) {
            for (var str of this) {
                if (str.containsIgnoreCase(that)) {
                    return true;
                }
            }
            return false;
        };

        var isSelectedSearch = function(user, txt) {
            if (!txt || txt == '') {
                return true;
            }
            var inputFields = ['name', 'phone', 'email', 'working_email', 'supervisor_name', 'supervisor_email'];
            var arrayFields = ['dept_names', 'visa_types'];
            for (var index of inputFields) {
                if (user[index].containsIgnoreCase(txt)) {
                    return true;
                }
            }
            for (var index of arrayFields) {
                if (user[index].containsStrIgnoreCase(txt)) {
                    return true;
                }
            }
            return false;
        };

        var search = function(ele) {
            var txt = ele.value;
            var userSeleted = [];
            for (var user of users) {
                if (isSelectedSearch(user, txt)) {
                    userSeleted.push(user);
                }
            }
            $('#public-info').html(publicInfoOf(userSeleted));
        }

        var isSelectedQuery = function(user, index, txt) {
            if (!index || index == '' || !txt || txt == '') {
                return true;
            }
            var inputFields = ['name', 'phone', 'email', 'working_email', 'supervisor_name', 'supervisor_email'];
            var arrayFields = ['dept_names', 'visa_types'];
            if (inputFields.includes(index)) {
                return user[index].containsIgnoreCase(txt);
            } else {
                return user[index].containsStrIgnoreCase(txt);
            }
        }

        var query = function(ele, index) {
            var txt = ele.value;
            var userSeleted = [];
            for (var user of users) {
                if (isSelectedQuery(user, index, txt)) {
                    userSeleted.push(user);
                }
            }
            $('#public-info').html(publicInfoOf(userSeleted));
        }
    </script>
    <div id="body" class="container-fluid">
          <h1 class="page-header">UC Davis Department Contacts</h1>
          <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'name')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Phone
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'phone')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Email
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Official University Email<br />(primary contact)
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'working_email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Departments
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'dept_names')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Visa Types
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'visa_types')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Supervisor's Name
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_name')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Supervisor's Email
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                    </tr>
                </thead>
              <tbody id="public-info">

              </tbody>
            </table>
          </div>
        </div>
</body>
</html>
