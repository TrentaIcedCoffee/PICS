<!-- TODO welcome -> 404 -->
<!-- TODO inner -> package -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- jQuery 2.0.0 CDN -->
    <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
    <!-- Angular CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <!-- bootstrap 3 CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <!-- customized packages -->
    <script src="js/exceptions.js"></script>
    <script src="js/date.js"></script>
    <script src="js/util.js"></script>
    <script src="js/crypto/core.js"></script>
    <script src="js/crypto/enc-base64.js"></script>
    <script src="js/crypto/hmac.js"></script>
    <script src="js/crypto/sha256.js"></script>
    <script src="js/crypto/util.js"></script>
    <title>Redirect - Debug</title>
    <style>
        .navbar-inverse .navbar-brand {
            color: rgba(235, 235, 235, 1);
        }
        .interact {
            font-size: 18px !important;
        }
        .express {
            color: rgba(235, 235, 235, 1);
        }
        .express-inverse {
            color: rgba(0, 0, 0, 1) !important;
        }
        .express-large {
            font-size: 22px !important;
        }
        .express-medium {
            font-size: 20px !important;
        }
        .express-small {
            font-size: 18px !important;
        }
        .input-group {
            width: 100%;
        }
        .btn-full {
            width: 100%;
        }
        .ul-wide {
            width: 100%;
        }
        .ul-wide li.dropdown-header {
            padding-left: 4%;
        }
        .ul-wide li {
            padding-left: 6%;
        }
        .ul-responsive li:hover {
            background-color: rgba(200, 200, 200, 1);
        }
        .select-full {
            width: 100%;
        }
        .error {
            color: red;
            display: none;
        }
        html, body {
            width: 100%;
            font-family: 'Roboto', sans-serif;
            background: rgba(240, 240, 240, 0.3);
        }
        #header {
            height: 50px;
        }
        #header div a {
            margin: 0px;
            float: none;
            display: block;
            text-align: center;
        }
        #header div input {
            width: 100%;
        }
        #header div.col-md-3.navbar-header a:hover {
            background-color: rgba(80, 80, 80, 0.7);
            cursor: pointer;
        }
        #private-info {
            position: absolute;
            display: none;
        }
        #private-basic, #private-general, #private-depts_and_visas, #private-supervisor {
            background: black;
            border-radius: 20px;
            border: solid black 4px;
            padding-bottom: 6px;
        }
        #private-basic h2, #private-general h2, #private-depts_and_visas h2, #private-supervisor h2 {
            margin: 0px;
            padding-top: 10px;
            padding-bottom: 8px;
            padding-left: 2%;
            text-align: left;
        }
        #private-basic div.input-group, #private-general div.input-group, #private-depts_and_visas div.input-group, #private-supervisor div.input-group {
            width: 96%;
            margin-left: 2%;
        }
        #body {
			margin-top: 50px;
			padding-top: 30px;
		}
        #public-info tr:hover {
            background: rgba(255, 255, 255, 1);
        }
</style>
</head>
<body>
    <script>
        // usr validation
        var cookie = document.cookie;
        if (cookie == undefined || cookie == "") {
            window.location.replace('welcome.html');
        }
        var jwt = getJwtInCookie(cookie);
        var email = getEmailInJwt(jwt);
        var _id = getIdOfEmail(email);
        if (!isValidJwt(jwt, _id)) {
            window.location.replace('welcome.html'); // TODO welcome -> 404
        }
    </script>
    <script>
        // $.ajax({url: `users/${_id}`, async: true, dataType: 'json'}).done(function(res) {
        //     var user = res;
        //     console.log(user);
        // });
        var user = JSON.parse($.ajax({url: `users/${_id}`, async: false, dataType: 'json'}).responseText);
        var users = JSON.parse($.ajax({url: 'users', async: false, dataType: 'json'}).responseText);
    </script>
    <nav id="header" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-3 navbar-header">
              <a class="navbar-brand express express-large active" onclick="togglePrivateInfo(this)">My Information <span class="caret"></span></a>
            <script>
                // private-basic
                var h2PrivateBasic = function() {
                    return '<h2 class="express express-medium">Basic Info</h2>';
                };
                var inputPrivateBasic = function(token, value) {
                    var result = '';
                    result += '<div class="input-group">';
                    result += `<span class="input-group-addon"><i class="glyphicon glyphicon-${token}"></i></span>`;
                    result += `<input class="form-control interact" readonly="readonly" value="${value}" />`;
                    result += '</div>';
                    return result;
                }
                var btnPrivateBasic = function(type, target, value) {
                    var result = '';
                    result += '<div class="input-group">';
                    result += `<button class="btn btn-${type} btn-full interact" data-toggle="modal" data-target="${target}" type="button">${value}</button>`
                    result += '</div>';
                    return result;
                };
                var privateBasic = function(user) {
                    var result = '';
                    result += '<div id="private-basic">';
                    result += h2PrivateBasic();
                    result += inputPrivateBasic('user', user.email);
                    result += inputPrivateBasic('calendar', user.stop_time);
                    result += btnPrivateBasic('warning', '#model-change_password', 'Change password');
                    result += btnPrivateBasic('danger', '#model-delete_user', 'Delete this user');
                    result += '</div>';
                    return result;
                }

                // private-general
                var h2PrivateGeneral = function() {
                    return '<h2 class="express express-medium"><span><button class="btn btn-primary" onclick="toggleGeneralInfoLock()"><i class="glyphicon glyphicon-lock"></i></button></span>&nbsp;&nbsp;&nbsp;&nbsp;General Info</h2>';
                };
                var inputPrivateGeneral = function(token, value) {
                    var result = '';
                    result += '<div class="input-group">';
                    result +=  `<span class="input-group-addon"><i class="glyphicon glyphicon-${token}"></i></span>`;
                    result += `<input class="form-control interact" readonly="readonly" onchange="updateGeneralInfo()" value="${value}" />`;
                    result += '</div>';
                    return result;
                };
                var privateGeneral = function(user) {
                    var result = '';
                    result += '<div id="private-general">';
                    result += h2PrivateGeneral();
                    result += inputPrivateGeneral('user', user.name);
                    result += inputPrivateGeneral('phone', user.phone);
                    result += inputPrivateGeneral('envelope', (user.working_email || ''));
                    result += inputPrivateGeneral('comment', (user.note || ''));
                    result += '</div>';
                    return result;
                }

                // private-depts_and_visas
                var h2PrivateDeptsAndVisas = function() {
                    return '<h2 class="express express-medium"><span><button class="btn btn-primary" data-toggle="modal" data-target="#model-update_depts_and_visas"><i class="glyphicon glyphicon-edit"></i></button></span>&nbsp;&nbsp;&nbsp;&nbsp;Departments and Visas</h2>';
                };
                var dropdownPrivateDeptsAndVisas = function(label, data) {
                    var result = '';
                    result += '<div class="input-group clearfix">';
                    result += `<button class="btn btn-info btn-full dropdown-toggle interact" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">${label}<span class="caret"></span></button>`;
                    result += '<ul class="dropdown-menu ul-wide ul-responsive">';
                    result += `<li class="dropdown-header express-inverse express-small">${label}</li>`;
                    for (var val of data) {
                        result += `<li class="interact">${val}</li>`;
                    }
                    result += '</ul>';
                    result += '</div>';
                    return result;
                };
                var privateDeptsAndVisas = function(user) {
                    var result = '';
                    result += '<div id="private-depts_and_visas">';
                    result += h2PrivateDeptsAndVisas();
                    result += dropdownPrivateDeptsAndVisas('Departments', user.dept_names);
                    result += dropdownPrivateDeptsAndVisas('Visas', user.visa_types);
                    result += '</div>';
                    return result;
                };

                // private-supervisor
                var h2PrivateSupervisor = function() {
                    return '<h2 class="express express-medium"><span><button class="btn btn-primary" onclick="toggleSupervisorLock()"><i class="glyphicon glyphicon-lock"></i></button></span>&nbsp;&nbsp;&nbsp;&nbsp;Supervisor Info</h2>';
                };
                var inputPrivateSupervisor = function(token, value) {
                    var result = '';
                    result += '<div class="input-group">';
                    result += `<span class="input-group-addon"><i class="glyphicon glyphicon-${token}"></i></span>`;
                    result += `<input class="form-control interact" readonly="readonly" onchange="updateSupervisor()" value="${value}" />`;
                    result += '</div>';
                    return result;
                };
                var privateSupervisor = function(user) {
                    var result = '';
                    result += '<div id="private-supervisor">';
                    result += h2PrivateSupervisor();
                    result += inputPrivateSupervisor('user', (user.supervisor_name || ''));
                    result += inputPrivateSupervisor('envelope', (user.supervisor_email || ''));
                    result += '</div>';
                    return result;
                };

                // private-info
                var privateInfo = function(user) {
                    var result = '';
                    result += privateBasic(user);
                    result += privateGeneral(user);
                    result += privateDeptsAndVisas(user);
                    result += privateSupervisor(user);
                    return result;
                };

                $(document).ready(function() {
                    $('#private-info').html(privateInfo(user));
                });
            </script>
            <div id="private-info">
            </div>
            <script>
                var toggleGeneralInfoLock = function() {
                    var token = $('#private-general h2 button i');
                    if (token.hasClass('glyphicon-lock')) {
                        token.removeClass('glyphicon-lock');
                        token.addClass('glyphicon-edit');
                        $('#private-general input').prop('readonly', false);
                    } else {
                        token.removeClass('glyphicon-edit');
                        token.addClass('glyphicon-lock');
                        $('#private-general input').prop('readonly', true);
                    }
                }
                var updateGeneralInfo = function () {
                    // TODO impl POST
                };
                var toggleSupervisorLock = function() {
                    var token = $('#private-supervisor h2 button i');
                    if (token.hasClass('glyphicon-lock')) {
                        token.removeClass('glyphicon-lock');
                        token.addClass('glyphicon-edit');
                        $('#private-supervisor input').prop('readonly', false);
                    } else {
                        token.removeClass('glyphicon-edit');
                        token.addClass('glyphicon-lock');
                        $('#private-supervisor input').prop('readonly', true);
                    }
                };
                var updateSupervisor = function() {
                    // TODO impl POST
                };
                var togglePrivateInfo = function(ele) {
                	var trigger = $(ele);
                	if (trigger.hasClass('active')) {
                		trigger.removeClass('active');
                		$('#private-info').slideUp();
                	} else {
                		trigger.addClass('active');
                		$('#private-info').slideDown();
                	}
                };
            </script>
            </div>
              <div class="col-md-6 navbar-header">
                  <a class="navbar-brand" href="#">PICS - UC Davis Department Comtacts</a>
              </div>
              <form class="col-md-3 navbar-form navbar-right">
                  <input oninput="search(this)" type="text" class="form-control" placeholder="Search...">
              </form>
          </div>
      </div>
    </nav>
    <script>
        String.prototype.containsIgnoreCase = function(that) {
            var thisLowerCase = this.toLowerCase();
            var thatLowerCase = that.toLowerCase();
            return thisLowerCase.indexOf(thatLowerCase) != -1;
        };

        Array.prototype.containsStrIgnoreCase = function(that) {
            for (var str of this) {
                if (str.containsIgnoreCase(that)) {
                    return true;
                }
            }
            return false;
        };

        var isSelectedSearch = function(user, txt) {
            if (!txt || txt == '') {
                return true;
            }
            var inputFields = ['name', 'phone', 'email', 'working_email', 'supervisor_name', 'supervisor_email'];
            var arrayFields = ['dept_names', 'visa_types'];
            for (var index of inputFields) {
                if (user[index].containsIgnoreCase(txt)) {
                    return true;
                }
            }
            for (var index of arrayFields) {
                if (user[index].containsStrIgnoreCase(txt)) {
                    return true;
                }
            }
            return false;
        };

        var search = function(ele) {
            var txt = ele.value;
            var userSeleted = [];
            for (var user of users) {
                if (isSelectedSearch(user, txt)) {
                    userSeleted.push(user);
                }
            }
            $('#public-info').html(publicInfoOf(userSeleted));
        }

        var isSelectedQuery = function(user, index, txt) {
            if (!index || index == '' || !txt || txt == '') {
                return true;
            }
            var inputFields = ['name', 'phone', 'email', 'working_email', 'supervisor_name', 'supervisor_email'];
            var arrayFields = ['dept_names', 'visa_types'];
            if (inputFields.includes(index)) {
                return user[index].containsIgnoreCase(txt);
            } else {
                return user[index].containsStrIgnoreCase(txt);
            }
        }

        var query = function(ele, index) {
            var txt = ele.value;
            var userSeleted = [];
            for (var user of users) {
                if (isSelectedQuery(user, index, txt)) {
                    userSeleted.push(user);
                }
            }
            $('#public-info').html(publicInfoOf(userSeleted));
        }
    </script>
    <div id="body" class="container-fluid">
          <h1 class="page-header">UC Davis Department Contacts</h1>
          <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'name')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Phone
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'phone')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Email
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Official University Email<br />(primary contact)
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'working_email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Departments
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'dept_names')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Visa Types
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'visa_types')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Supervisor's Name
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_name')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                        <th>Supervisor's Email
                            <div class="input-group">
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_email')" placeholder="Search for..." />
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <script>
                    var td = function(value) {
                        if (typeof value == 'string') {
                            return `<td class="interact">${value}</td>`;
                        } else {
                            return `<td class="interact">${value.join(',<br />')}</td>`;
                        }
                    };
                    var tr = function(user) {
                        var result = '';
                        result += '<tr>';
                        result += td(user.name);
                        result += td(user.phone);
                        result += td(user.email);
                        result += td(user.working_email || '');
                        result += td(user.dept_names);
                        result += td(user.visa_types);
                        result += td(user.supervisor_name || '');
                        result += td(user.supervisor_email || '');
                        result += '</tr>';
                        if (user.note) {
                            result += '<tr>';
                            result += `<td class="note-public" colspan="8">Note: ${user.note}</td>`;
                            result += '</tr>';
                        }
                        return result;
                    }
                    var publicInfo = function(users, filter) {
                        var usersSelected = filter(users);
                        var result = '';
                        for (var user of usersSelected) {
                            result += tr(user);
                        }
                        return result;
                    }
                    
                </script>
              <tbody id="public-info">

              </tbody>
            </table>
          </div>
        </div>
</body>
</html>
