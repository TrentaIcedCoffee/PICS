<!-- TODO welcome -> 404 -->
<!-- TODO inner -> package -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- jQuery 2.0.0 CDN -->
    <script src="http://code.jquery.com/jquery-2.0.0.js"></script>
    <!-- Angular CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <!-- bootstrap 3 CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <!-- customized packages -->
    <script src="js/exceptions.js"></script>
    <script src="js/date.js"></script>
    <script src="js/util.js"></script>
    <script src="js/crypto/core.js"></script>
    <script src="js/crypto/enc-base64.js"></script>
    <script src="js/crypto/hmac.js"></script>
    <script src="js/crypto/sha256.js"></script>
    <script src="js/crypto/util.js"></script>
    <script src="js/render.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <title>Redirect - Debug</title>
</head>
<body>
    <script>
        // usr validation
        var cookie = document.cookie;
        if (cookie == undefined || cookie == "") {
            window.location.replace('welcome.html');
        }
        var jwt = getJwtInCookie(cookie);
        var email = getEmailInJwt(jwt);
        var _id = getIdOfEmail(email);
        if (!isValidJwt(jwt, _id)) {
            window.location.replace('welcome.html'); // TODO welcome -> 404
        }
    </script>
    <script>
        // $.ajax({url: `users/${_id}`, async: true, dataType: 'json'}).done(function(res) {
        //     var user = res;
        //     console.log(user);
        // });
        var user = JSON.parse($.ajax({url: `users/${_id}`, async: false, dataType: 'json'}).responseText);
        var users = JSON.parse($.ajax({url: 'users', async: false, dataType: 'json'}).responseText);
    </script>
    <nav id="header" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-3 navbar-header">
              <a class="navbar-brand express express-large active" onclick="togglePrivateInfo(this)">My Information <span class="caret"></span></a>
                <script>
                    $(document).ready(function() {
                        $('#private-info').html(privateInfo(user));
                    });
                </script>
            <div id="private-info">
            </div>
            <script>
                var toggleGeneralInfoLock = function() {
                    var token = $('#private-general h2 button i');
                    if (token.hasClass('glyphicon-lock')) {
                        token.removeClass('glyphicon-lock');
                        token.addClass('glyphicon-edit');
                        $('#private-general input').prop('readonly', false);
                    } else {
                        token.removeClass('glyphicon-edit');
                        token.addClass('glyphicon-lock');
                        $('#private-general input').prop('readonly', true);
                    }
                }
                var updateGeneralInfo = function () {
                    // TODO impl POST
                };
                var toggleSupervisorLock = function() {
                    var token = $('#private-supervisor h2 button i');
                    if (token.hasClass('glyphicon-lock')) {
                        token.removeClass('glyphicon-lock');
                        token.addClass('glyphicon-edit');
                        $('#private-supervisor input').prop('readonly', false);
                    } else {
                        token.removeClass('glyphicon-edit');
                        token.addClass('glyphicon-lock');
                        $('#private-supervisor input').prop('readonly', true);
                    }
                };
                var updateSupervisor = function() {
                    // TODO impl POST
                };
                var togglePrivateInfo = function(ele) {
                	var trigger = $(ele);
                	if (trigger.hasClass('active')) {
                		trigger.removeClass('active');
                		$('#private-info').slideUp();
                	} else {
                		trigger.addClass('active');
                		$('#private-info').slideDown();
                	}
                };
            </script>
            </div>
            <div class="col-md-6 navbar-header">
                <a class="navbar-brand express express-large">PICS - UC Davis Department Comtacts</a>
            </div>
            <div class="col-md-3 navbar-right">
                <form class="navbar-form">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                        <input class="form-control interact" oninput="search(this)" type="text" placeholder="Global search...">
                    </div>
                </form>
            </div>
          </div>
      </div>
    </nav>
    <script>
        String.prototype.containsIgnoreCase = function(that) {
            var thisLowerCase = this.toLowerCase();
            var thatLowerCase = that.toLowerCase();
            return thisLowerCase.indexOf(thatLowerCase) != -1;
        };

        Array.prototype.containsStrIgnoreCase = function(that) {
            for (var str of this) {
                if (str.containsIgnoreCase(that)) {
                    return true;
                }
            }
            return false;
        };

    </script>
    <div id="body" class="container-fluid">
        <h1 class="page-header">UC Davis Department Contacts</h1>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="express-inverse express-medium">
                            Name
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'name')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Phone
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'phone')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Email
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'email')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Official University Email<br />(primary contact)
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'working_email')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Departments
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'dept_names')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Visa Types
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'visa_types')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Supervisor's Name
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_name')" placeholder="Search for..." />
                            </div>
                        </th>
                        <th class="express-inverse express-medium">
                            Supervisor's Email
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                                <input class="form-control" type="text" oninput="query(this, 'supervisor_email')" placeholder="Search for..." />
                            </div>
                        </th>
                    </tr>
                </thead>
                <script>
                    var td = function(value) {
                        if (typeof value == 'string') {
                            return `<td class="interact">${value}</td>`;
                        } else {
                            return `<td class="interact">${value.join(',<br />')}</td>`;
                        }
                    };

                    var tr = function(user) {
                        var result = '';
                        result += '<tr>';
                        result += td(user.name);
                        result += td(user.phone);
                        result += td(user.email);
                        result += td(user.working_email || '');
                        result += td(user.dept_names);
                        result += td(user.visa_types);
                        result += td(user.supervisor_name || '');
                        result += td(user.supervisor_email || '');
                        result += '</tr>';
                        if (user.note) {
                            result += '<tr>';
                            result += `<td class="note-public" colspan="8">Note: ${user.note}</td>`;
                            result += '</tr>';
                        }
                        return result;
                    }

                    var publicInfo = function(users, filter) {
                        var usersSelected = filter(users);
                        var result = '';
                        for (var user of usersSelected) {
                            result += tr(user);
                        }
                        return result;
                    }

                    $(document).ready(function() {
                        $('#public-info').html(publicInfo(users, function(users) {
                            return users;
                        }));
                    });
                </script>
              <tbody id="public-info">

              </tbody>
            </table>
          </div>
        </div>
        <div class="modal fade" id="model-change_password" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Change Password</h4>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                            <input id="input-old_password" class="form-control interact" placeholder="Old password" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                            <input id="input-new_password" class="form-control interact" placeholder="New password" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                            <input id="input-new_password_retyped" class="form-control interact" placeholder="Retype new password" />
                        </div>
                        <div class="interact error" id="error-old_password_mismatch">Old password incorrect</div>
                        <div class="interact error" id="error-retyped_password_mismatch">Inconsistent new passwords</div>
                        <div class="interact error" id="error-short_password">New password has to be 6 characters or more</div>
                        <button class="btn btn-warning btn-full interact" onclick="changePassword()" type="button">Change password</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var changePassword = function() {
            	// TODO impl changePassword
            };
        </script>
        <div class="modal fade" id="model-delete_user" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Delete This User</h4>
                    </div>
                    <div class="modal-body">
                        <p>This action <b>cannot</b> be undone. This will <b>permanently delete</b> all information of this user<br /><br />
                            Please type in your email <b><span id="span-user_email"></span></b> to confirm.
                        </p>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                            <input class="form-control interact" oninput="confirmEmail(this)" placeholder="Email" />
                        </div>
                        <button id="btn-delete_user" class="btn btn-danger btn-full interact" onclick="deleteUser()" type="button" disabled>Delete this user</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function() {
            	$('#span-user_email').text(user.email);
            });
            var confirmEmail = function(ele) {
            	if (ele.value == user.email) {
            		$('#btn-delete_user').prop('disabled', false);
            	} else {
            		$('#btn-delete_user').prop('disabled', true);
            	}
            };
            var deleteUser = function() {
            	// TODO: impl DELETE
            }
        </script>
        <div ng-controller="controller-update_depts_and_visas" class="modal fade" id="model-update_depts_and_visas" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Edit Departments and Visas</h4>
                    </div>
                    <div class="modal-body">
                        <div class="interact">Deparment - select department(s) for which you process visas. Please at least select 1 department</div>
                        <div class="input-group">
                            <select class="select-full selectpicker" id="select-dept_names" multiple ng-model="inputDeptNames" data-live-search="true">
                                <option class="interact" ng-repeat="deptNameChoice in deptNameChoices">{{deptNameChoice}}</option>
                            </select>
                        </div>
                        <br />
                        <div class="interact">Visa type(s) - Please at least select 1 visa type</div>
                        <div class="input-group">
                            <select class="select-full selectpicker" id="select-visa_types" multiple ng-model="inputVisaTypes" data-live-search="true">
                                <option class="interact" ng-repeat="visaTypeChoice in visaTypeChoices">{{visaTypeChoice}}</option>
                            </select>
                        </div>
                        <div class="error" id="error-empty_dept_names">Must choose at least 1 department.</div>
                        <div class="error" id="error-empty_visa_types">Must choose at least 1 visa type.</div>
                        <button class="btn btn-warning btn-full interact" onclick="updateDeptNamesAndVisaTypes()" type="button">Update</button>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var visaTypes = ['J-1', 'H-1B', 'O-1', 'TN', 'PR', 'E'];
			var deptNames = ["Evolution & Ecology","Microbiology and Molecular Genetics","Molecular and Cellular Biology","Neurobiology Physiology and Behavior","Plant Biology","Art and Art History","Cinema & Technocultural Studies","Music","Theatre & Dance","Biological and Agricultural Engineering","Food Science and Technology","Textiles and Clothing","Viticulture and Enology","East Asian Studies","Economics","Hemispheric Institute of the Americas","History","Agricultural and Resource Economics","Environmental Science and Policy","Human Ecology","Animal Science","Nutrition","Anthropology","Middle East/South Asia Studies","Sociology","Environmental Toxicology","Land Air and Water Resources","Wildlife Fish and Conservation Biology","Communication","International Relations","Linguistics","Political Science","UC Center Sacramento (UCCS)","Entomology","Nematology","Plant Pathology","African American and African Studies","Agr and Envir Science Office of Dean","Agricultural Issues Center","Agricultural Sustainability Institute","Air Quality Research Center","American Studies","Asian American Studies","Biological Chemistry","Biomedical Engineering","Bodega Marine Laboratory","Budget and Institutional Analysis","California Institute of Food and Agricultural Research","California Lighting Technology Center","Center for Health & Technology","Center for Health and the Environment","Center for Healthcare Policy and Research","Center for Mind and Brain","Center for Molecular and Genomic Imaging","Center for Neuroscience","Center for Regional Change","Center for Science and Innovation Studies","Center for Student Affairs Assessement","Center for Transnational Health","Center for Watershed Sciences","Chancellor and Provost Office","Chemical Engineering and Materials Science","Chemistry","Chicana/o Studies","Civil and Environmental Engineering","Classics Program","Comparative Literature","Computer Science","Counseling and Psychological Services","Davis Language Center","Department of Design","Design and Construction Management","Division of Agriculture and Natural Resources","Earth and Planetary Sciences","East Asian Languages and Cultures","Electrical and Computer Engineering","Energy Institute","English","Facilities Management","French and Italian","Gender, Sexuality and Women's Studies","Genome Center","German Department","Global Affairs Confucius Institute","Global Affairs Fulbright","Global Affairs Humphrey","Global Affairs Sponsored Programs","Global Affairs Staff Exchange","Grad Group in Cultural Studies","Graduate School of Management","Hart Interdisciplinary Programs","Humanities Institute","Humanities, Arts and Cultural Studies","Information and Educational Technology","Institute for Governmental Affairs","Institute for Transportation Studies","Intercollegiate Athletics","International & Community Nutrition","International Law Programs","International Programs of the CA & ES","JMIE Center for Watershed Science","JMIE Road Ecology Center","JMIE Tahoe Environmental Research Center","Law School Dean's Office","Mathematics","McClellan Nuclear Research Center","Mechanical and Aerospace Engineering","MED Anesthesiology and Pain Medicine","MED Biochemistry and Molecular Medicine","MED Cancer Center","MED Cell Biology and Human Anatomy","MED Center for Biophotonics","MED Center for Musculoskeletal Health","MED Center for Reducing Health Disparities","MED Center for Virtual Care","MED Dermatology","MED Emergency Medicine","MED Family and Community Medicine","MED Global Health Sciences","MED Health Information Management","MED Hematology and Oncology","MED IM Aging and Education Center","MED IM Cardiovascular Medicine","MED IM Gastroenterology and Hepatology","MED IM Pulmonary and Critical Care Medicine","MED IM Rheumatology Allergy & Clinical Immunology","MED Imaging Research Center","MED Infectious Diseases","MED Institute for Population Health & Improvement","MED Internal Medicine","MED M.I.N.D. Institute","MED Medical Pathology","MED Microbiology and Immunology","MED Nephrology","MED Neurological Surgery","MED Neurology","MED Obstetrics and Gynecology","MED Office of Medical Education","MED Ophthalmology","MED Orthopaedic Surgery","MED Otolaryngology","MED Pathology and Laboratory Medicine","MED Patient Care Services Emergency Room","MED Pediatrics","MED Pharmacology","MED Physical Medicine and Rehabilitation","MED Physiology and Membrane Biology","MED Primary Care Network Operations","MED Psychiatry and Behavioral Medicine","MED Public Health Sciences","MED Radiation Oncology","MED Radiology","MED Stem Cell Program","MED Surgery","MED Urology","Mondavi Center","Native American Studies","NEAT ORU and Thermochemistry Unit","Nuclear Magnetic Resonance Facility","Office of the Vice Chancellor for Research","Olive Center","Other","Philosophy","Physical Education Program","Physics","Plant Sciences","Psychology","Religious Studies","Safety Services","School of Education","School of Nursing","Science and Technology Studies","Services for International Students and Scholars","Spanish Portuguese","Statistics","Student Health & Counseling Services","UC Cooperative Extension","University Extension","University Writing Program","VM Anatomy Physiology and Cell Biology","VM California Animal Health and Food Safety","VM California National Primate Research Center","VM Center for Companion Animal Health","VM Center for Comparative Medicine","VM Center for Equine Health","VM Center for Lab Animal Science","VM International Laboratory of Molecular Biology","VM Medicine & Epidemiology","VM Molecular Biosciences","VM One Health Institute","VM Pathology Microbiology and Immunology","VM Population Health and Reproduction","VM Surgical and Radiological Sciences","VM Veterinary Genetics Lab","VM Veterinary Medical Teaching Hospital","VM Veterinary Medicine Extension Public Programs","VM Veterinary Medicine Teaching and Research Center","VM Western Institute for Food Safety and Security","VM Wildlife Health Center","Western Cooling Efficiency Center", "Others (please indicate at Note)"];

            app.controller('controller-update_depts_and_visas', function($scope, $http) {
            	$scope.deptNameChoices = deptNames;
            	$scope.visaTypeChoices = visaTypes;
            	// TODO: impl POST
            })
        </script>
</body>
</html>
